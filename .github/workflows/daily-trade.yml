name: Daily Trade Execution

on:
  schedule:
    # Run at 8:30 PM UTC (3:30 PM ET during standard time) OR
    # Run at 7:30 PM UTC (3:30 PM ET during daylight saving time)
    - cron: '30 19,20 * * 1-5'
  workflow_dispatch: # Allow manual triggering

jobs:
  run-trade:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements_no_nvidia.txt

    - name: Check if it's during the 3 PM Eastern Time hour
      run: |
        # Get current time in America/New_York timezone
        current_ny_hour=$(TZ="America/New_York" date +"%H")
        current_ny_minute=$(TZ="America/New_York" date +"%M")

        echo "Current time in New York: ${current_ny_hour}:${current_ny_minute}"
        echo "Checking if we're in the 3 PM hour (15:00-15:59 ET)"

        if [ "$current_ny_hour" = "15" ]; then
          echo "Within 3 PM ET hour. Proceeding with trade execution."
          echo "SKIP_TRADE=false" >> $GITHUB_ENV
        else
          echo "Not within 3 PM ET hour (current hour: $current_ny_hour). Skipping execution."
          echo "SKIP_TRADE=true" >> $GITHUB_ENV
        fi

    - name: Execute trade script
      if: env.SKIP_TRADE != 'true'
      id: trade
      run: |
        echo "Starting trade execution at $(date)"
        # Change to backend/src directory and run the trading script
        cd backend/src

        # Capture both stdout and stderr
        output=$(python -m alpaca-trader.trader --symbol SPUS --model ../saved_models/0bb6a8ce-d506-4faf-bd3c-9384e7544dc4.pkl --paper 2>&1)
        exit_code=$?

        # Store the output for later use
        echo "TRADE_OUTPUT<<EOF" >> $GITHUB_ENV
        echo "$output" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        echo "TRADE_EXIT_CODE=$exit_code" >> $GITHUB_ENV

        # Print output for debugging
        echo "$output"

        if [ $exit_code -eq 0 ]; then
          echo "Trade execution completed successfully"
        else
          echo "Trade execution failed with exit code $exit_code"
        fi

    - name: Send email notification
      if: env.SKIP_TRADE != 'true' && always() # Only send if trade was supposed to run
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: |
          Daily Trade Execution Results - ${{ env.SKIP_TRADE == 'true' && 'SKIPPED' || (env.TRADE_EXIT_CODE == '0' && 'SUCCESS' || 'FAILED') }} - $(date +'%Y-%m-%d %H:%M ET')
        body: |
          Daily Trade Execution Report
          =============================

          Execution Time: $(date)
          Status: ${{ env.SKIP_TRADE == 'true' && 'SKIPPED - Wrong timezone execution' || (env.TRADE_EXIT_CODE == '0' && 'SUCCESS' || 'FAILED') }}
          ${{ env.SKIP_TRADE == 'true' && 'Exit Code: N/A' || format('Exit Code: {0}', env.TRADE_EXIT_CODE) }}

          Trade Output:
          -------------
          ${{ env.TRADE_OUTPUT }}

          ---
          This is an automated message from your trading workflow.
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: Trading Bot <${{ secrets.EMAIL_USERNAME }}>
        content_type: text/plain
